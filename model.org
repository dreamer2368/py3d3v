#+TITLE:  3d3v Electrostatic PIC Code
#+AUTHOR: Scott High
#+LATEX_HEADER: \newcommand{\pd}[2]{\frac{\partial #1}{ \partial #2}}

#+begin_src python :session :exports none
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import numpy as np
#+end_src

#+RESULTS:

* Model Definition

** General description
Approximating a 3 dimensional plasma using a finite number of
negatively charged electrons and positively charge ions.

- Particle dynamics are simulated by solving
  \[ F = q(E+v \times B) \]
  where
  \[ E = -\nabla \phi \]
  and
  \[ \nabla^2 \phi = -\frac{\rho}{\epsilon_0} \]
  - $\phi$ is approximated from the mesh charge density using an FFT
    based algorithm
  - $E$ is approximated from $\phi$ using second order centered finite
    differences
- The time integrator is Leap-Frog
  - $v$ is advanced using the Boris Method
  - $x$ is advanced in the obvious way using $v$
  - See below for details
- Particle charges are interpolated to a uniform mesh to approximate
  $\rho$ using the cloud in cell (CIC) method. This is equivalent to
  linear interpolation.
- The magnetic field is uniform in the $z$ direction, and is held
  constant at $B_0$.
- Particles are free to move in $x, y, z$ and have velocity components
  $v_x, v_y, v_z$

** Algorithm

1) Weight charges $q_i$ to the uniform mesh to get charge density $\rho$
   - Cloud in cell (CIC)
2) Solve $\nabla^2 \phi(t) = -\frac{\rho}{\epsilon_0}$ for $\phi(t)$
   1) Use FFT to convert mesh charge density $\rho(x_i)$ to $\rho(k)$
   2) Solve $K^2 \phi(k) = \frac{\rho(k)}{\epsilon_0}$ for $\phi(k)$ where
      $K^2 = k^2 \left(\frac{\sin(k dx/2)}{k dx/2}\right)^2$
   3) Use IFFT to get $\phi(x_i)$ from $\phi(k)$
3) Solve $E(t) = -\nabla \phi(t)$ for $E_x, E_y, E_z$
   - Second order centered finite differences
4) Interpolate $E_x, E_y, E_z$ to particle positions
   - Cloud in cell (CIC)
5) Advance $v(t-\Delta t/2) \to v(t+\Delta t/2)$ using $E(t)$
6) Advance $x(t) \to x(t+\Delta t)$ using $v(t+\Delta t/2)$

*** Time integration details

**** Boris method for advancing $v$
\begin{equation}
v^{-} = v_{t-\Delta t/2} + \frac{qE}{m} \frac{\Delta t}{2}
\end{equation}
\begin{equation}
\frac{v^+-v^-}{\Delta t} = \frac{q}{2m}(v^+ + v^-)\times B
\end{equation}
\begin{equation}
v_{t+\Delta t/2} = v^+ + \frac{qE}{m}\frac{\Delta t}{2}
\end{equation}

**** Advancing $x$
\[ x(t+\Delta t) = x(t) + v(t+\Delta t/2) \Delta t \]

* Model Validation

** Langmuir Oscillations
Langmuir oscillations are simple harmonic density waves that form in
cold plasmas in response to small perturbations in the initial charge
density (with $B_0=0$). For simplicity we create oscillations only in
the $x$ direction. To approximate the conditions in a cold plasma, the
simulation volume is filled with a large number of particles with
charge chosen such that particles in the $y$-$z$ plane approximate
sheet charges with charge density $q$.

The particle displacements are expected to follow
\[ \ddot{\delta x} = - \omega_p^2 \delta x \]
which is simple harmonic motion with period
$\omega_p=(\frac{nq^2}{m \epsilon_0})^{1/2}$.

*** Initial Conditions
- Position perturbation: $x = x_0 + A \cos(k x_0)$
  - Corresponds to a $\sin$ perturbation in the initial density at the
    same mode
- Expected density: $\rho(x, t) \propto \sin(kx)\cos(\omega t)$

*** Dispersion relations
- For a cold plasma at rest
  \[ \omega(\bold{k}) = \omega_p \]
- The numerical dispersion relation is
  \[ \omega(k) = \omega_p \cos\left(\frac{k \Delta x}{2}\right) \]

*** Derivation
We are searching for linearized small amplitude wave solutions at high
frequencies.
Since ions are considerably more massive than electrons, we hold them
fixed (assume $\frac{m_e}{m_i} \to 0$)
Then, we can write electron density $n$ and velocity $v$ as
\[ n = n_0 + \hat{n} e^{i(k x-\omega t)} \]
\[ v = \hat{v} e^{i(k x-\omega t)} \]
We will linearize Maxwell's equations by assuming hatted
variables $\hat{}$ are small.
Combine the Lorentz force with potential $\phi$ to get
\[ m \frac{d v}{dt} = q E = -q \frac{d \phi}{d x}  \]
\[ k^2 \hat{\phi} = \frac{q}{\epsilon_0} \hat{n} \]
\[ \implies \omega m \hat{v} = \frac{q^2}{\epsilon_0 k^2} \hat{n} \]
Applying the continuity equation
\[ \pd{n}{t} + \pd{(n v)}{x} = 0  \]
to solve for $\hat{n}$ in terms of $\hat{v}$ where the second order
terms are dropped yields
\[ -i \omega \hat{n} + i k n_0 \hat{v} = 0 \]
\[ \implies \hat{n} = \frac{k n_0}{\omega} \hat{v} \]
Combine the above equations to get
\[ \omega m \hat{v} = \frac{q^2}{\epsilon_0 k} \hat{n}
                     = \frac{q^2 n_0}{\epsilon_0 \omega} \hat{v} \]
\[ \implies \omega^2 = \left(\frac{q^2 n_0}{\epsilon_0 m}\right)^2 = \omega_p^2 \]
Then the only frequency supported is $\omega = \omega_p$, which is independent
of $k$. 

*** Numerical Results
- Initial charge positions are equispaced in the domain
- $\omega$ vs $k$ for fixed $dx$ (with constant $L$)
  
  [[file:py3d3v/wk_fixed_dx.png]]
  - ppc = average particles per cell per dimension before pertubation
    - Total average particles per cell before pertubation will be ppc$^3$
  - Number of grid points = $64^3$
  - $L_x = L_y = L_z = 2\pi$
  - $dx = dy = dz = \frac{64}{2\pi}$
  - Number of charges = $(\text{ppc}\times 64)^3$
  - $k = \text{mode}\cdot \frac{2\pi}{L}$
- Choosing parameters
  - With ppc=2 the experimental numerical dispersion approaches the
    expected numerical dispersion $\omega(k) = \omega_p\cos(\frac{k
    dx}{2})$
- Measuring $\omega$
  - If the initial density is pertubed in the $k^{th}$ fourier mode,
    the density is expected to follow $\rho(k, t) \propto \cos(\omega
    t)$, which is generally complex.  Then we can use the fact that
    $\rho(k, t) \rho^*(k, t) \propto \cos^2(\omega t) =
    \frac{1}{2}(\cos(2\omega t)-1)$ is real to compute $\omega$. The
    first 10 time steps are averaged to produce the estimated
    $\omega$. The results produced using this method are consistent
    with measuring $\omega$ directly from particle displacements and
    are simpler to calculate.
- I am currently investigating the high error when ppc<1.
  
** Plasma Sheath
When a plasma comes into contact with a metal surface, the faster
moving electrons deposit charge on the surface faster than the slower
moving ions. This leads to a net negative charge on the surface, which
is balanced out by a net positive charge a short distance from the
wall. The resulting region of positive charge is called the plasma
sheath.

* Numerical Dispersion Relation for Langmuir Oscillations
:PROPERTIES:
:ID:       694886f9-6045-412b-9902-a8061390e16f
:END:
We start by deriving expressions for $F(k)$ and $\rho(k)$. These will
be combined at the end to produce our numerical dispersion relation.
First make the following definitions:
- $S(x)$ is the weight function and its fourier transform $S(k)$ is
  the weight factor. This is normalized such that $\Delta x \sum_j
  S(X_j-x) = 1$
- $X_j = j \Delta x$ is the jth grid point
- $k_p = k - p k_g$ where $k_g = \frac{2\pi}{\Delta x}$

The force on a charge $q$ at $x$ is given by
\[ F(x) = q \Delta x \sum_j E_j S(X_j-x) \]
\begin{align*}
  F(k) &= \int_{-\infty}^\infty dx F(x) e^{-ikx} \\
       &= \int dx q\Delta x \sum_j S(X_j-x) e^{ik(X_j-x)} e^{-ikX_j} \\
       &= q \Delta x \sum_j E_j e^{-ikX_j} \int S(X_j-x) e^{ik(X_j-x)} dx \\
       &= q \Delta x \sum_j E_j e^{-ikX_j} S(-k) \\
       &= q E(k) S(-k)
\end{align*}

Define the "cloud density" function $\rho_c$ as
\[ \rho_c(x) = q \int_{-\infty}^{\infty} dx' S(x'-x) n(x') \]
Then, by the convolution theorem
\[ \rho_c(k) = q S(k) n(k) \]
The charge density at points on the grid is given by
\begin{align*}
  \rho(x_i) &= \int_{-\infty}^{\infty} \frac{dk}{2\pi} e^{i k x_i} \rho_c(k) \\
            &= \int_{-\pi/\Delta x}^{\pi/\Delta x} \frac{dk}{2\pi} e^{i k x_i}
               \sum_{p=-\infty}^{\infty}\rho_c(k_p) \\
  \implies \rho(k) &= \sum_{p=-\infty}^{\infty}\rho_c(k_p) \\
                   &= \sum_{p=-\infty}^{\infty} S(k_p) n(k_p)
\end{align*}
This shows the coupling of different modes induced by the grid. 

We know from the derivation of Langmuir oscillations above that
\[ n(k) = i \frac{k n_0}{m \omega^2} F(k) \]
and
\[ -i \kappa(k) \phi(k) = E(k) \]
For the following we will always use $\kappa(k) = k \frac{\sin(k dx)}{k dx}$,
which corresponds to differentiating $E$ with a second order centered finite
difference stencil.

Finally, we put everything together to get
\begin{align*}
  \rho(k)
    &= q \sum_{p=-\infty}^{\infty} S(k_p) n(k_p) \\
    &= \frac{q n_0}{m} \sum_{p=-\infty}^{\infty} \frac{i k_p S(k_p) F(k_p)}{\omega^2} \\
    %&= \frac{q^2 n_0}{m} \sum_{p=-\infty}^{\infty} \frac{i k_p S^2(k_p) E(k_p)}{\omega^2} \\
    &= \frac{q^2 n_0}{m} \sum_{p=-\infty}^{\infty}
                         \frac{k_p S^2(k_p) \kappa(k_p) \phi(k_p)}{\omega^2} \\
    &= \frac{q^2 n_0}{m} \phi(k) \sum_{p=-\infty}^{\infty}
                         \frac{k_p S^2(k_p) \kappa(k_p)}{\omega^2} \\
    &= \frac{q^2 n_0}{m\epsilon_0} \frac{\rho(k)}{K^2(k)} \sum_{p=-\infty}^{\infty}
                         \frac{k_p S^2(k_p) \kappa(k_p)}{\omega^2} \\
    \implies \omega^2 &=
      \omega_p^2 \left[\frac{1}{K^2(k)}\sum_{p=-\infty}^{\infty}
                 k_p S^2(k_p) \kappa(k_p)\right] \\
\end{align*}

We make use of the identity
\[ \sum_p(k-k_p)^{-3} = \left[ \frac{2}{dx} \sin(k dx/2) \right]^{-3} cos(k dx/2)  \]
to simplify the sum
\begin{align*}
  \sum_p k_p \kappa(k_p) S^2(k_p) &= \sum_p k_p^2 \frac{\sin(k_p dx)}{k_p dx}
                                                  \left(\frac{\sin(k_p dx/2)}{k_p dx/2} \right)^4 \\
  &= \frac{2^4 \sin(k dx) \sin^4(k dx/2)}{(dx)^5} \sum_p k_p^{-3} \\
  &= \frac{2 \sin(k dx) \sin(k dx/2) \cos(k dx/2)}{(dx)^2}  \\
\end{align*}

The function $K(k)$ is determined by the method used to differentiate $\phi$
in gauss's law. 
We consider the following two cases:
\[ K^2(k) = k^2  \]
which corresponds to exact spectral differentiation and
\[ K^2(k) = k^2 \left(\frac{\sin(k dx/2)}{k dx/2}\right)^2 \]
which corresponds to a second order centered finite difference evaluation of $\phi$,
$\frac{d^2 \phi}{dx^2} = \frac{1}{dx^2}(\phi(X_{j-1})-2\phi(X_{j})+\phi(X_{j+1})$.
For the following analysis we will assume that CIC weighting is used, so that
$S(k) = \left(\frac{\sin(k dx/2)}{k dx/2} \right)^2$.

In the first case where $K^2(k) = k^2$ we (finally) get the result
\[ \omega^2 = \omega_p^2 
     \left[\frac{2}{(kdx)^2} \sin(kdx)sin(kdx/2)\cos(kdx/2) \right] \]

In the second case where
$K^2(k) = k^2 \left(\frac{\sin(k dx/2)}{k dx/2}\right)^2$
we get, after applying the double angle identity,
\[ \omega^2 = \omega_p^2 \cos^2(kdx/2) \]

#+NAME: disp-plot
#+BEGIN_SRC python :session :results file :exports results
  xv = np.linspace(.01, .5, 20)
  a = np.cos(xv/2.)
  b = 2*np.sin(xv)*np.sin(xv/2.)*np.cos(xv/2.)/xv**2
  fig = plt.figure()
  ax = fig.add_subplot(111)
  ax.plot(xv, a, label="Finite Diff"); ax.plot(xv, b, label="Spectral");
  c = np.ones_like(a)
  ax.plot(xv, c, 'b--', label="$\omega_p$")
  ax.set_xlabel("$k dx$"); ax.set_ylabel("$\omega(k)$");
  ax.set_title("$\omega$ vs. $\omega(k)$")
  ax.set_ylim((.91, 1.01))
  ax.legend(loc="lower left")
  fig.savefig("disp.png")
  "disp.png"
#+END_SRC

#+RESULTS: disp-plot
[[file:disp.png]]

* Implementing P3M
I am starting with a Gaussian (S3) to make life a little easier.

** Force calculation details
The screen function S3 is defined as
\[ f(r; \beta) = \frac{\beta^3}{\pi^{3/2}} e^{-\beta^2 x^2} \]
\[ \hat{f}(k; \beta) = e^{-k^2/(2\beta)^2} \]

The field produced by a gaussian charge distribution is
\[ |E| = \frac{1}{2\pi^{3/2}}\left[\frac{\sqrt{\pi}}{2R^2}erf(R\beta)-\frac{\beta}{R}e^{-\beta^2 R^2}\right] \]
This follows by applying Gauss's law together with the
definition of $f$.
